 CREATE OR REPLACE STORAGE INTEGRATION PBI_Integration
  TYPE = EXTERNAL_STAGE
  STORAGE_PROVIDER = 'S3'
  ENABLED = TRUE
  STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::327075712874:role/powerbi.role'
  STORAGE_ALLOWED_LOCATIONS = ('s3://powerbi.projectbucket/')
  COMMENT = 'Optional Comment'

  DESC INTEGRATION PBI_Integration;



  
  CREATE database PowerBI;
  create schema PBI_Data;
  create table PBI_Dataset (
Year int,	Location string,	Area	int,
Rainfall	float, Temperature	float, Soil_type string,
Irrigation	string, yeilds	int,Humidity	float,
Crops	string,price	int,Season string
);

  SELECT * FROM  PBI_DATASET;

  
  CREATE STAGE POWERBI.PBI_DATA.PBI_STAGE
  url = 's3://powerbi.projectbucket/'
storage_integration = PBI_Integration

copy into PBI_Dataset 
from @pbi_stage
file_format = (type=csv field_delimiter=',' skip_header=1 )
on_error = 'continue'


  SELECT * FROM  PBI_DATASET;

  SELECT YEAR ,COUNT(*) FROM PBI_DATASET GROUP BY YEAR;

  //make a rough table agriculture so that we can do data transformation into that particular table and our original dataset remains the same.


  create table agriculture as
select * from pbi_dataset;

SELECT * FROM AGRICULTURE;

//if we want to increase rainfall 10% of the actual rainfall

update agriculture
set rainfall=1.1*rainfall;

SELECT * FROM AGRICULTURE;

//if we want to decrease area 10% of the actual area

update agriculture
set area=0.9*area;

SELECT * FROM AGRICULTURE;

//Year 2004 & 2009 - Y1
//Year 2010 & 2015 - Y2
//Year 2016 & 2019 - Y3


//adding another column in agriculture  table for year_group.
ALTER  TABLE agriculture
add Year_Group string;

SELECT * FROM agriculture;

//as of now null values will be shown in the year_group column ,,,to divide the groups and insert values we have to update the column.

update agriculture
set year_group='Y1'
where year >=2004 and year<=2009;

update agriculture
set year_group='Y2'
where year >=2010 and year<=2015;

update agriculture
set year_group='Y3'
where year >=2016 and year<=2019;

select * from agriculture;

//Make rainfall groups:
//min value 255 
//max value 4103

//rainfall 255 & 1200 - Low
//rainfall 1200 2800 - Medium
//Rainfall 2800 & 4103 - High

ALTER TABLE agriculture
add Rainfall_Groups string;

SELECT * FROM agriculture;

Update agriculture
set rainfall_groups='Low'
where rainfall>=255 and rainfall<1200;

Update agriculture
set rainfall_groups='Medium'
where rainfall>=1200 and rainfall<2800;

Update agriculture
set rainfall_groups='High'
where rainfall>=2800 and rainfall<4103;

select * from agriculture;